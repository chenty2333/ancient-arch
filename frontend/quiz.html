<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è¶£å‘³ç­”é¢˜ | å¤ç­‘ä¹‹å…‰</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav>
        <a href="index.html" class="logo">ANCIENT ARCH</a>
        <div class="links">
            <a href="index.html">ç™¾ç§‘</a>
            <a href="community.html">ç¤¾åŒº</a>
            <a href="quiz.html" class="active">è¶£å‘³ç­”é¢˜</a>
            <a href="qualification.html">èµ„æ ¼è®¤è¯</a>
            <a href="profile.html" class="auth-only hidden">ä¸ªäººä¸­å¿ƒ</a>
            <a href="login.html" class="guest-only">ç™»å½•</a>
            <a href="#" onclick="logout()" class="auth-only hidden">é€€å‡º</a>
        </div>
    </nav>

    <div class="container">
        <header style="text-align: center; margin-bottom: 3rem;">
            <h1>å¤å»ºç­‘çŸ¥è¯†æŒ‘æˆ˜</h1>
            <p style="color: var(--gray-dark)">ä¸å…¨ç«™ç”¨æˆ·ä¸€è¾ƒé«˜ä¸‹ï¼Œæµ‹è¯•ä½ çš„çŸ¥è¯†å‚¨å¤‡ã€‚</p>
        </header>

        <div class="grid" style="grid-template-columns: 2fr 1fr; align-items: start;">
            <!-- å·¦ä¾§ï¼šç­”é¢˜åŒº -->
            <div>
                <div id="quiz-start-panel" class="card" style="text-align: center; padding: 3rem;">
                    <h3>å‡†å¤‡å¥½äº†å—ï¼Ÿ</h3>
                    <p style="margin: 1rem 0;">æ¯æ¬¡éšæœºç”Ÿæˆ 10 é“é¢˜ç›®ï¼Œè®¡å…¥æ€»ç§¯åˆ†ã€‚</p>
                    <button onclick="startQuiz()" style="font-size: 1.1rem; padding: 0.8rem 2rem;">å¼€å§‹æŒ‘æˆ˜</button>
                </div>

                <div id="quiz-panel" class="hidden">
                    <form id="quiz-form">
                        <!-- é¢˜ç›® -->
                    </form>
                    <button onclick="submitQuiz()" style="width: 100%; margin-top: 2rem;">æäº¤ç­”æ¡ˆ</button>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ’è¡Œæ¦œ -->
            <div>
                <div class="card" style="background: #fafafa;">
                    <h3 style="border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin-bottom: 1rem;">ğŸ† ç§¯åˆ†æ¦œ</h3>
                    <div id="leaderboard">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="core.js"></script>
    <script>
        let quizToken = "";

        // åŠ è½½æ’è¡Œæ¦œ
        async function loadLeaderboard() {
            try {
                const list = await request("/quiz/leaderboard");
                const el = document.getElementById("leaderboard");
                if (!list || list.length === 0) {
                    el.innerHTML = "<p>æš‚æ— æ’è¡Œæ•°æ®</p>";
                    return;
                }
                el.innerHTML = list.map((item, idx) => `
                    <div class="flex-between" style="margin-bottom: 0.8rem; font-size: 0.9rem;">
                        <span>
                            <span style="font-weight: bold; width: 20px; display: inline-block; color: ${idx<3 ? '#b00020' : '#888'}">${idx+1}</span>
                            ${item.username}
                        </span>
                        <span style="font-weight: bold;">${item.score}</span>
                    </div>
                `).join('');
            } catch(e) {}
        }

        async function startQuiz() {
            if (!state.token) {
                statusBar.show("è¯·å…ˆç™»å½•", "error");
                setTimeout(() => window.location.href = "login.html", 1000);
                return;
            }

            try {
                const res = await request("/quiz/generate");
                if (!res || !res.questions) {
                    statusBar.show("ç”Ÿæˆè¯•å·å¤±è´¥", "error");
                    return;
                }
                
                quizToken = res.exam_token;
                renderQuiz(res.questions);
                document.getElementById("quiz-start-panel").classList.add("hidden");
                document.getElementById("quiz-panel").classList.remove("hidden");
            } catch(e) {}
        }

        function renderQuiz(questions) {
            const form = document.getElementById("quiz-form");
            form.innerHTML = questions.map((q, idx) => {
                let opts = q.options;
                if (typeof opts === 'string') {
                    try { opts = JSON.parse(opts); } catch(e) {}
                }
                return `
                <div class="card" style="margin-bottom: 1rem;">
                    <p style="font-weight: bold; margin-bottom: 0.5rem;">${idx+1}. ${q.content}</p>
                    ${opts.map((opt, i) => `
                        <label style="display: block; margin: 0.3rem 0; cursor: pointer;">
                            <input type="radio" name="q-${q.id}" value="${String.fromCharCode(65+i)}">
                            ${opt}
                        </label>
                    `).join('')}
                </div>
                `;
            }).join('');
        }

        async function submitQuiz() {
            const form = document.getElementById("quiz-form");
            const formData = new FormData(form);
            const answers = {};

            for (let [key, value] of formData.entries()) {
                const qId = key.split('-')[1];
                answers[qId] = value;
            }

            try {
                const res = await request("/quiz/submit", {
                    method: "POST",
                    body: JSON.stringify({
                        exam_token: quizToken,
                        answers: answers
                    })
                });
                
                if (res) {
                    document.getElementById("quiz-panel").innerHTML = `
                        <div class="card" style="text-align: center; padding: 2rem;">
                            <h2>æŒ‘æˆ˜ç»“æŸ</h2>
                            <div style="font-size: 3rem; font-weight: bold; margin: 1rem 0;">${res.score}åˆ†</div>
                            <p style="color: var(--gray-dark); margin-bottom: 2rem;">æ­£ç¡®æ•°: ${res.correct_count}</p>
                            <div style="display: flex; gap: 1rem; justify-content: center;">
                                <button onclick="window.location.reload()">å†æ¥ä¸€æ¬¡</button>
                                <button class="secondary" onclick="window.location.href='index.html'">è¿”å›é¦–é¡µ</button>
                            </div>
                        </div>
                    `;
                }
            } catch(e) {}
        }

        loadLeaderboard();
    </script>
</body>
</html>