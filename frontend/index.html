<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>古筑之光 | 首页</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav>
        <a href="index.html" class="logo">ANCIENT ARCH</a>
        <div class="links">
            <a href="index.html" class="active">百科</a>
            <a href="community.html">社区</a>
            <a href="quiz.html">趣味答题</a>
            <a href="qualification.html">资格认证</a>
            <a href="profile.html" class="auth-only hidden">个人中心</a>
            <a href="login.html" class="guest-only">登录</a>
            <a href="#" onclick="logout()" class="auth-only hidden">退出</a>
        </div>
    </nav>

    <div class="container">
        <header>
            <h1>建筑图书馆</h1>
            <p style="color: var(--gray-dark)">探索中华大地的结构之美。</p>
            
            <div id="category-filter" style="margin-top: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                <button onclick="filterCategory('')" class="secondary active">全部</button>
                <button onclick="filterCategory('Palace')" class="secondary">宫殿</button>
                <button onclick="filterCategory('Temple')" class="secondary">寺庙</button>
                <button onclick="filterCategory('Garden')" class="secondary">园林</button>
                <button onclick="filterCategory('Tomb')" class="secondary">陵墓</button>
                <button onclick="filterCategory('Bridge')" class="secondary">桥梁</button>

                <div style="margin-left: auto;">
                    <input type="text" id="arch-search" placeholder="搜索古建筑..." style="width: 200px;">
                </div>
            </div>
        </header>

        <div id="arch-grid" class="grid">
            <!-- 动态加载 -->
        </div>
    </div>

    <script src="core.js"></script>
    <script>
        let currentCategory = "";
        let currentQuery = "";

        async function loadArchitectures() {
            try {
                let endpoint = "/architectures";
                const params = [];
                if (currentCategory) params.push(`category=${currentCategory}`);
                if (currentQuery) params.push(`q=${encodeURIComponent(currentQuery)}`);
                
                if (params.length > 0) {
                    endpoint += "?" + params.join("&");
                }

                const data = await request(endpoint);
                const grid = document.getElementById("arch-grid");
                
                if (!data || data.length === 0) {
                    grid.innerHTML = "<p>暂无此类建筑数据。</p>";
                    return;
                }

                grid.innerHTML = data.map(arch => `
                    <a href="architecture-detail.html?id=${arch.id}" class="card">
                        <img src="${escapeHtml(arch.cover_img) || 'https://placehold.co/400x300?text=No+Image'}" alt="${escapeHtml(arch.name)}">
                        <div>
                            <span class="card-tag">${escapeHtml(arch.dynasty)}</span>
                            <span class="card-tag">${escapeHtml(arch.category)}</span>
                            <h3 style="margin-top:0.5rem">${escapeHtml(arch.name)}</h3>
                            <p style="font-size:0.8rem; color: var(--gray-dark)">${escapeHtml(arch.location)}</p>
                        </div>
                    </a>
                `).join('');
            } catch (e) {
                // error handled by core.js
            }
        }

        function filterCategory(cat) {
            currentCategory = cat;
            // Update active state
            const buttons = document.querySelectorAll("#category-filter button.secondary");
            buttons.forEach(b => b.classList.remove("active"));
            
            // 简单匹配文本
            buttons.forEach(b => {
                const map = {'': '全部', 'Palace': '宫殿', 'Temple': '寺庙', 'Garden': '园林', 'Tomb': '陵墓', 'Bridge': '桥梁'};
                if (b.textContent === map[cat]) b.classList.add("active");
            });

            loadArchitectures();
        }

        function doSearch() {
            currentQuery = document.getElementById("arch-search").value.trim();
            loadArchitectures();
        }

        document.getElementById("arch-search").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                doSearch();
            }
        });

        loadArchitectures();
    </script>
</body>
</html>